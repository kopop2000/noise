name: Build VST2 Plugin

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Clone and Build (Ignore Test Errors)
      run: |
        git clone https://github.com/vaisest/noise-suppression-for-voice.git
        cd noise-suppression-for-voice
        
        mkdir build
        cd build
        
        # Конфигурируем проект
        cmake .. -G "Visual Studio 17 2022" -A x64
        
        # Собираем только основные цели, пропускаем тесты
        cmake --build . --config Release --target noise_suppression --target noise_suppression_vst3 || echo "Some targets failed, but continuing..."
        
    - name: Find and List DLL Files
      run: |
        echo "=== ALL DLL FILES ==="
        dir noise-suppression-for-voice\build\ /s *.dll
        dir noise-suppression-for-voice\build\ /s *.vst3
        
        echo "=== RELEASE FOLDER ==="
        dir noise-suppression-for-voice\build\Release\ /s
        
    - name: Upload DLL Files
      uses: actions/upload-artifact@v4
      with:
        name: noise-suppression-dll
        path: |
          noise-suppression-for-voice/build/Release/*.dll
          noise-suppression-for-voice/build/Release/*.vst3
        if-no-files-found: warn
