name: Build Noise Suppression VST2 Plugin

on:
  workflow_dispatch:  # Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # ÐÐ²Ñ‚Ð¾ÑÐ±Ð¾Ñ€ÐºÐ° Ñ€Ð°Ð· Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ

env:
  BUILD_TYPE: Release
  VST2_SDK_URL: https://github.com/robbert-vdh/nih-plug/archive/refs/heads/main.zip

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, Win32]
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      
    - name: Clone Noise Suppression Repository
      run: |
        git clone https://github.com/vaisest/noise-suppression-for-voice.git
        cd noise-suppression-for-voice
        git log -1 --oneline
      
    - name: Setup Build Environment
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Install Dependencies
      run: |
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ CMake
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ VST2 SDK
        curl -L ${{ env.VST2_SDK_URL }} -o vst2_sdk.zip
        7z x vst2_sdk.zip -o.vst2_sdk
      
    - name: Configure Project
      run: |
        cd noise-suppression-for-voice
        mkdir build_${{ matrix.arch }}
        cd build_${{ matrix.arch }}
        cmake .. ^
          -G "Visual Studio 17 2022" ^
          -A ${{ matrix.arch }} ^
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
          -DBUILD_VST_PLUGIN=ON ^
          -DBUILD_VST3=OFF ^
          -DBUILD_STANDALONE=OFF ^
          -DENABLE_GRAPHICAL_UI=ON ^
          -DVST2_SDK_PATH="${{ github.workspace }}/.vst2_sdk" ^
          -DUSE_AVX2=ON ^
          -DUSE_SSE4=ON ^
          -DLOW_LATENCY=ON
      
    - name: Build Project
      run: |
        cd noise-suppression-for-voice/build_${{ matrix.arch }}
        cmake --build . --config ${{ env.BUILD_TYPE }} --parallel 4
      
    - name: List Built Files
      run: |
        echo "=== Built files ==="
        dir noise-suppression-for-voice\build_${{ matrix.arch }}\ /s
        dir noise-suppression-for-voice\build_${{ matrix.arch }}\Release\ /s
        dir noise-suppression-for-voice\build_${{ matrix.arch }}\bin\ /s 2>nul || echo "No bin directory"
      
    - name: Upload VST2 Plugin
      uses: actions/upload-artifact@v4
      with:
        name: noise-suppression-vst2-${{ matrix.arch }}
        path: |
          noise-suppression-for-voice/build_${{ matrix.arch }}/Release/*.dll
          noise-suppression-for-voice/build_${{ matrix.arch }}/Release/*.vst
          noise-suppression-for-voice/build_${{ matrix.arch }}/bin/Release/*.dll
        retention-days: 30
        if-no-files-found: error
  
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Build Linux Version
      run: |
        git clone https://github.com/vaisest/noise-suppression-for-voice.git
        cd noise-suppression-for-voice
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_LV2=ON
        make -j4

  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release Package
      run: |
        mkdir -p release_package
        cp -r noise-suppression-vst2-* release_package/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÐµÐ¹
        cat > release_package/README.txt << EOF
        Noise Suppression VST2 Plugin for EqualizerAPO
        
        Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð¯ ÐŸÐž Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ•:
        
        1. Ð”Ð»Ñ 64-Ð±Ð¸Ñ‚Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ð¿Ð°Ð¿ÐºÐ¸ x64
        2. Ð”Ð»Ñ 32-Ð±Ð¸Ñ‚Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ - Ð¸Ð· Ð¿Ð°Ð¿ÐºÐ¸ Win32  
        3. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» .dll Ð² Ð¿Ð°Ð¿ÐºÑƒ Ñ VST Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°Ð¼Ð¸
        4. Ð’ EqualizerAPO Configurator Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ:
           Plugin: VST:noise_suppression.dll
        5. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "Edit" Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°
        
        Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:
        - Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ ÑˆÑƒÐ¼Ð¾Ð¿Ð¾Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
        - Ð ÐµÐ¶Ð¸Ð¼Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ (ÐÐ³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ð¹/Ð£Ð¼ÐµÑ€ÐµÐ½Ð½Ñ‹Ð¹/Ð›ÐµÐ³ÐºÐ¸Ð¹)
        - Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ¼Ð±Ñ€Ð° Ð³Ð¾Ð»Ð¾ÑÐ°
        - Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ¿ÐµÐºÑ‚Ñ€Ð°
        
        ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ ÐžÐ¡: Windows 10/11 (64-bit Ð¸ 32-bit)
        EOF
        
        # ÐÑ€Ñ…Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÑ‘
        7z a -r noise_suppression_vst2.zip release_package/*
      
    - name: Upload Final Release
      uses: actions/upload-artifact@v4
      with:
        name: noise-suppression-final-release
        path: noise_suppression_vst2.zip
        retention-days: 90

  notify:
    needs: [create-release]
    runs-on: ubuntu-latest
    steps:
    - name: Notify Completion
      run: |
        echo "ðŸŽ‰ Ð¡Ð±Ð¾Ñ€ÐºÐ° VST2 Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
        echo "ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ñ€Ð°Ð·Ð´ÐµÐ»Ð° Artifacts"
        echo "ðŸ”§ ÐÑ€Ñ…Ð¸Ð²: noise-suppression-final-release.zip"
